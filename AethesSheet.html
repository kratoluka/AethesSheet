<input type="hidden" class="sheet-tabstoggle" name="attr_sheetTab" value="character"/>
<div>
    <button type="action" name="act_overview">Overview</button>
    <button type="action" name="act_stats">Stats</button>
    <button type="action" name="act_attacks">Attacks</button>
    <button type="action" name="act_perks">Perks</button>
    <button type="action" name="act_rune-spells">Rune Spells</button>
    <button type="action" name="act_inventory">Inventory</button>
    <button type="action" name="act_invocation">Invocation</button>
</div>

<div class="sheet-overview">
    <text> Name:</text>
    <input type="text" name="attr_character_name" readonly/><br>
    Race: <input type="text" name="attr_race" value="" readonly/><br>

    <strong> Level: </strong>
    <input type="number" name="attr_level" value="1" readonly/><br>
    <strong> Initiative: </strong>
    <input type="number" name="attr_initiative_total" value="1" readonly/><br>
    <strong> Evasion: </strong>
    <input type="number" name="attr_evasion_total" value="1" readonly/><br>
    <strong> Speed: </strong>
    <input type="number" name="attr_speed_total" value="1" readonly/><br>
    <strong> Equip Load: </strong>
    <input type="number" value="0" name="attr_equip_load"/>
    <text> /</text>
    <input type="number" value="1" name="attr_equip_load_max" readonly/><br>

    <strong> Health: </strong>
    <input type="number" value="0" name="attr_hp"/>
    <text> /</text>
    <input type="number" value="10" name="attr_hp_max" readonly/>

    <strong> Vitality: </strong>
    <input type="number" value="0" name="attr_vitality"/>
    <text> /</text>
    <input type="number" value="10" name="attr_vitality_max" readonly/>

    <strong> Focus: </strong>
    <input type="number" value="0" name="attr_fp"/>
    <text> /</text>
    <input type="number" value="10" name="attr_fp_max" readonly/>

    <strong> Stamina: </strong>
    <input type="number" value="0" name="attr_sp"/>
    <text> /</text>
    <input type="number" value="10" name="attr_sp_max" readonly/>
    <br>
    <button type="action" name="act_rest">Rest</button>


    <hr>
    <h2>Character Stats</h2>

    <br>
    <h3> Vigor </h3>
    <input type="number" name="attr_Vigor" value="1" min="1" readonly/>
    <button type='roll' value="/roll 1d20 + @{Vigor} + @{Vigor_bonus} Vigor" name="roll_Vigor"></button>
    <br>
    <h3> Endurance </h3>
    <input type="number" name="attr_Endurance" value="1" min="1" readonly/>
    <button type='roll' value="/roll 1d20 + @{Endurance} + @{Endurance_bonus} Endurance" name="roll_Endurance"></button>
    <br>
    <h3> Intelligence </h3>
    <input type="number" name="attr_Intelligence" value="1" min="1" readonly/>
    <button type='roll' value="/roll 1d20 + @{Intelligence} + @{Intelligence_bonus} Intelligence" name="roll_Intelligence"></button>
    <br>
    <h3> Strength </h3>
    <input type="number" name="attr_Strength" value="1" min="1" readonly/>
    <button type='roll' value="/roll 1d20 + @{Strength} + @{Strength_bonus} Strength" name="roll_Strength"></button>
    <br>
    <h3> Dexterity </h3>
    <input type="number" name="attr_Dexterity" value="1" min="1" readonly/>
    <button type='roll' value="/roll 1d20 + @{Dexterity} + @{Dexterity_bonus} Dexterity" name="roll_Dexterity"></button>
    <br>
    <h3> Perception </h3>
    <input type="number" name="attr_Perception" value="1" min="1"/>
    <button type='roll' value="/roll 1d20 + @{Perception} + @{Perception_bonus} Perception" name="roll_Perception"></button>
    <br>
    <h3> Arcana </h3>
    <input type="number" name="attr_Arcana" value="1" min="1"/>
    <button type='roll' value="/roll 1d20 + @{Arcana} + @{Arcana_bonus} Arcana" name="roll_Arcana"></button>
    <br>
    <h3> Faith </h3>
    <input type="number" name="attr_Faith" value="1" min="1"/>
    <button type='roll' value="/roll 1d20 + @{Faith} + @{Faith_bonus} Faith" name="roll_Faith"></button>
    <br>
    <h3> Nature </h3>
    <input type="number" name="attr_Nature" value="1" min="1"/>
    <button type='roll' value="/roll 1d20 + @{Nature} + @{Nature_bonus} Nature" name="roll_Nature"></button>
    <br>
    <h3> Charisma </h3>
    <input type="number" name="attr_Charisma" value="1" min="1"/>
    <button type='roll' value="/roll 1d20 + @{Charisma} + @{Charisma_bonus} Charisma" name="roll_Charisma"></button>

    <hr>
    <h2>Attacks</h2>
    <fieldset class="repeating_attacks" id="repeat-overview" readonly>
        <strong>Name:</strong>
        <input type="text" name="attr_attack_name" readonly/>
        <button type="action" name="act_hit">Hit</button>
    </fieldset>
    <hr>

    <br>
    <h2>Armour</h2>
    <strong> Physical: </strong>
    <input type="number" name="attr_phys_armour_total" value="1" min="1" readonly/>
    <br>
    <strong> Magical: </strong>
    <input type="number" name="attr_mag_armour_total" value="1" min="1" readonly/>
    <br>

    <strong> Resistant to: </strong>
    <fieldset class="repeating_resistance">
        <input type="text" name="attr_resistance" readonly/>
    </fieldset>
    <hr>

    <h2>Rune Spells</h2>
    <strong> Memory: </strong>
    <input type="number" value="0" name="attr_spell_memory_used" readonly/>
    <text> /</text>
    <input type="number" value="3" name="attr_spell_memory" readonly/>
    <fieldset class="repeating_rune-spells" id="repeat-overview">
        <strong>Name:</strong>
        <input type="text" name="attr_rspell_name" readonly/>
        <strong>Ready:</strong>
        <input type="checkbox" name="attr_rspell_ready"/>
    </fieldset>
    <hr>

    <br><strong>Notes:</strong><br>
    <textarea name="attr_notes"></textarea>
</div>

<div class="sheet-stats">
    <text> Name:</text>
    <input type="text" name="attr_character_name"/><br>
    Race:
    <select name="attr_race">
        <option selected>Race</option>
        <option value="Human">Human</option>
        <option value="Half-Orc">Half-Orc</option>
        <option value="Orc">Orc</option>
        <option value="Seasonal Elf">Seasonal Elf</option>
        <option value="Sun Elf">Sun Elf</option>
        <option value="Moon Elf">Moon Elf</option>
        <option value="Half-Elf">Half-Elf</option>
        <option value="Dwarf">Dwarf</option>
        <option value="Smallfolk">Smallfolk</option>
        <option value="Felis">Felis</option>
        <option value="Beast Chibiki">Beast Chibiki</option>
        <option value="Merfolk">Merfolk</option>
        <option value="Turtlefolk">Turtlefolk</option>
        <option value="Demi-Giant">Demi-Giant</option>
        <option value="Dragonkin">Dragonkin</option>
        <option value="Djuri">Djuri</option>
        <option value="Construct">Construct</option>
        <option value="Changeling">Changeling</option>
        <option value="Devilkin">Devilkin</option>
    </select>
    <br>

    <hr>
    <h2>Stats</h2>

    <strong> XP: </strong>
    <input type="number" name="attr_xp" value="100"/>
    <strong> Level: </strong>
    <input type="number" name="attr_level" value="1" readonly/>
    <br>

    <strong> Health: </strong>
    <input type="number" value="10" name="attr_hp_base" readonly/>
    <text>Bonus</text>
    <input type="number" name="attr_hp_bonus" value="0"/>
    <br>

    <strong> Vitality: </strong>
    <input type="number" value="1" name="attr_vitality_base" readonly/>
    <text>Bonus</text>
    <input type="number" name="attr_vitality_bonus" value="0"/>
    <br>

    <strong> Focus: </strong>
    <input type="number" value="10" name="attr_fp_base" readonly/>
    <text>Bonus</text>
    <input type="number" name="attr_focus_bonus" value="0"/>
    <br>

    <strong> Stamina: </strong>
    <input type="number" value="1" name="attr_sp_base" readonly/>
    <text>Bonus</text>
    <input type="number" name="attr_sp_bonus" value="0"/>
    <br>

    <strong> Initiative: </strong>
    <input type="number" value="1" name="attr_initiative_base" readonly/>
    <text>Bonus</text>
    <input type="number" name="attr_initiative_bonus" value="0"/>
    <br>

    <strong> Evasion: </strong>
    <input type="number" value="1" name="attr_evasion_base" readonly/>
    <text>Bonus</text>
    <input type="number" name="attr_evasion_bonus" value="0"/>
    <br>

    <strong> Speed: </strong>
    <input type="number" value="20" name="attr_speed_base" readonly/>
    <text>Bonus</text>
    <input type="number" name="attr_speed_bonus" value="0"/>
    <br>

    <strong> Equip Load: </strong>
    <input type="number" value="1" name="attr_equip_load_base" readonly/>
    <text>Bonus</text>
    <input type="number" name="attr_equip_load_bonus" value="0"/>
    <br>

    <hr>
    <h2>Attributes</h2>

    <strong> XP Used: </strong>
    <input type="number" value="0" name="attr_xp_used" readonly/>
    <text> /</text>
    <input type="number" value="100" name="attr_xp" readonly/>
    <br>
    <h3> Vigor </h3>
    <input type="number" name="attr_Vigor" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_Vigor_bonus" value="0"/>
    <text>XP to increase</text>
    <input type="text" name="attr_Vigor_next" value="2" readonly/>
    <br>
    <h3> Endurance </h3>
    <input type="number" name="attr_Endurance" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_Endurance_bonus" value="0"/>
    <text>XP to increase</text>
    <input type="text" name="attr_Endurance_next" value="2" readonly/>
    <br>
    <h3> Intelligence </h3>
    <input type="number" name="attr_Intelligence" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_Intelligence_bonus" value="0"/>
    <text>XP to increase</text>
    <input type="text" name="attr_Intelligence_next" value="2" readonly/>
    <br>
    <h3> Strength </h3>
    <input type="number" name="attr_Strength" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_Strength_bonus" value="0"/>
    <text>XP to increase</text>
    <input type="text" name="attr_Strength_next" value="2" readonly/>
    <br>
    <h3> Dexterity </h3>
    <input type="number" name="attr_Dexterity" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_Dexterity_bonus" value="0"/>
    <text>XP to increase</text>
    <input type="text" name="attr_Dexterity_next" value="2" readonly/>
    <br>
    <h3> Perception </h3>
    <input type="number" name="attr_Perception" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_Perception_bonus" value="0"/>
    <text>XP to increase</text>
    <input type="text" name="attr_Perception_next" value="2" readonly/>
    <br>
    <h3> Arcana </h3>
    <input type="number" name="attr_Arcana" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_Arcana_bonus" value="0"/>
    <text>XP to increase</text>
    <input type="text" name="attr_Arcana_next" value="2" readonly/>
    <br>
    <h3> Faith </h3>
    <input type="number" name="attr_Faith" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_Faith_bonus" value="0"/>
    <text>XP to increase</text>
    <input type="text" name="attr_Faith_next" value="2" readonly/>
    <br>
    <h3> Nature </h3>
    <input type="number" name="attr_Nature" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_Nature_bonus" value="0"/>
    <text>XP to increase</text>
    <input type="text" name="attr_Nature_next" value="2" readonly/>
    <br>
    <h3> Charisma </h3>
    <input type="number" name="attr_Charisma" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_Charisma_bonus" value="0"/>
    <text>XP to increase</text>
    <input type="text" name="attr_Charisma_next" value="2" readonly/>

    <hr>
    <h2>Armour</h2>
    <br>
    <h3> Physical armour </h3>
    <input type="number" name="attr_phys_armour" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_phys_armour_bonus" value="0"/>
    <br>
    <h3> Magical armour </h3>
    <input type="number" name="attr_mag_armour" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_mag_armour_bonus" value="0"/>
    <br>

    <h3> Add resistance </h3>
    <fieldset class="repeating_resistance">
        <select name="attr_resistance">
            <option selected>-</option>
            <option value="Slashing">Slashing</option>
            <option value="Piercing">Piercing</option>
            <option value="Bludgeoning">Bludgeoning</option>
            <option value="Fire">Fire</option>
            <option value="Frost">Frost</option>
            <option value="Lightning">Lightning</option>
            <option value="Shadow">Shadow</option>
            <option value="Water">Water</option>
            <option value="Poison">Poison</option>
        </select>
    </fieldset>
</div>

<div class="sheet-attacks">
    <hr>
    <h2>Attacks</h2>
    <fieldset class="repeating_attacks">
        <strong>Name:</strong>
        <input type="text" name="attr_attack_name"/>
        Acc Bonus:
        <input type="number" name="attr_attack_acc_bonus"/>
        Dmg Bonus:
        <input type="number" name="attr_attack_dmg_bonus"/>
        Is Weapon
        <input type="checkbox" name="attr_attack_type"/>
        Scaling:
        <select name="attr_attack_scaling">
            <option selected>-</option>
            <option value="Vigor">Vigor</option>
            <option value="Endurance">Endurance</option>
            <option value="Intelligence">Intelligence</option>
            <option value="Strength">Strength</option>
            <option value="Dexterity">Dexterity</option>
            <option value="Perception">Perception</option>
            <option value="Arcana">Arcana</option>
            <option value="Faith">Faith</option>
            <option value="Nature">Nature</option>
            <option value="Charisma">Charisma</option>
        </select>
        One-Handed Dice:
        <input type="text" name="attr_attack_dice_one"/>
        Type:
        <select name="attr_attack_type_one">
            <option selected>-</option>
            <option value="Slashing">Slashing</option>
            <option value="Piercing">Piercing</option>
            <option value="Bludgeoning">Bludgeoning</option>
            <option value="Fire">Fire</option>
            <option value="Frost">Frost</option>
            <option value="Lightning">Lightning</option>
            <option value="Shadow">Shadow</option>
            <option value="Water">Water</option>
            <option value="Poison">Poison</option>
        </select>
        Two-Handed Dice:
        <input type="text" name="attr_attack_dice_two"/>
        Type:
        <select name="attr_attack_type_two">
            <option selected>-</option>
            <option value="Slashing">Slashing</option>
            <option value="Piercing">Piercing</option>
            <option value="Bludgeoning">Bludgeoning</option>
            <option value="Fire">Fire</option>
            <option value="Frost">Frost</option>
            <option value="Lightning">Lightning</option>
            <option value="Shadow">Shadow</option>
            <option value="Water">Water</option>
            <option value="Poison">Poison</option>
        </select>
        Secondary Dice:
        <input type="text" name="attr_attack_dice_secondary"/>
        Type:
        <select name="attr_attack_type_secondary">
            <option selected>-</option>
            <option value="Slashing">Slashing</option>
            <option value="Piercing">Piercing</option>
            <option value="Bludgeoning">Bludgeoning</option>
            <option value="Fire">Fire</option>
            <option value="Frost">Frost</option>
            <option value="Lightning">Lightning</option>
            <option value="Shadow">Shadow</option>
            <option value="Water">Water</option>
            <option value="Poison">Poison</option>
        </select>
    </fieldset>
    <hr>
</div>

<div class="sheet-perks">
    <hr>
    <h2>Perks</h2>
    <fieldset class="repeating_perks">
        <strong>Name:</strong>
        <input type="text" name="attr_perk_name"/>
        <strong>Requirements:</strong>
        <input type="text" name="attr_perk_requirements"/>
        <strong>Source:</strong>
        <input type="text" name="attr_perk_source"/>
        <br><strong>Description:</strong><br>
        <textarea name="attr_perk_note" cols="20" rows="2"></textarea>
    </fieldset>
    <hr>
</div>

<div class="sheet-rune-spells">
    <hr>
    <h2>Rune Spells</h2>
    <fieldset class="repeating_rune-spells">
        <strong>Name:</strong>
        <input type="text" name="attr_rspell_name"/>
        <strong>AP Cost:</strong>
        <input type="text" name="attr_rspell_ap"/>
        <strong>FP Cost:</strong>
        <input type="text" name="attr_rspell_fp"/>
        <strong>Damage:</strong>
        <input type="text" name="attr_rspell_dmg"/>
        <strong>Range:</strong>
        <input type="text" name="attr_rspell_range"/>
        <strong>Concentration:</strong>
        <input type="checkbox" name="attr_rspell_conc"/>
        <strong>Ready:</strong>
        <input type="checkbox" name="attr_rspell_ready"/>
        <br><strong>Description:</strong><br>
        <textarea name="attr_rspell_note" cols="20" rows="2"></textarea>
    </fieldset>
    <hr>
</div>

<div class="sheet-inventory">
    <hr>
    <h2>Inventory</h2>
    <fieldset class="repeating_inventory">
        <strong>Name:</strong>
        <input type="text" name="attr_item_name"/>
        <strong>Amount:</strong>
        <input type="text" name="attr_item_amount"/>
        <strong>Type:</strong>
        <input type="text" name="attr_item_type"/>
        <br><strong>Note:</strong><br>
        <textarea name="attr_item_note" cols="20" rows="2"></textarea>
    </fieldset>
    <hr>
</div>

<div class="sheet-invocation">
    <hr>
    <h2>Invocation Caster</h2>
        <strong>Template:</strong>
        <select name="attr_ic_template">
            <option value="touch" selected>Touch</option>
            <option value="bolt">Bolt</option>
            <option value="orb">Orb</option>
            <option value="cone">Cone</option>
            <option value="rebutal">Rebutal</option>
            <option value="cloud">Cloud</option>
            <option value="buff">Buff</option>
            <option value="enchantment">Enchantment</option>
            <option value="cloak">Cloak</option>
            <option value="aura">Aura</option>
            <option value="beam">Beam</option>
            <option value="wall">Wall</option>
            <option value="wave">Wave</option>
            <option value="explosion">Explosion</option>
            <option value="glyph">Glyph</option>
        </select>
        <strong>Tier:</strong>
        <select name="attr_ic_tier">
            <option selected>-</option>
            <option value="1">I</option>
            <option value="2">II</option>
            <option value="3">III</option>
            <option value="4">IV</option>
            <option value="5">V</option>
        </select>
        <br>
        <strong>Cast:</strong>
        <select name="attr_ic_type">
            <option value="arcane" selected>Arcane</option>
            <option value="faith">Faith</option>
            <option value="nature">Nature</option>
        </select>
        <input type="hidden" class="sheet-ic_type_toggle" name="attr_ic_type"  value="arcane"/> 
        <strong>Effect:</strong>
        <div class="sheet-arcane">
        <select name="attr_ic_effect">
            <option selected>-</option>
            <option value="fire_damage">Fire Damage</option>
            <option value="ice_damage">Ice Damage</option>
            <option value="shadow_damage">Shadow Damage</option>
            <option value="force_damage">Force Damage</option>
            <option value="dispel">Dispel</option>
            <option value="slow">Slow</option>
            <option value="haste">Haste</option>
            <option value="freeze">Freeze</option>
            <option value="resist_fire">Resist Fire</option>
            <option value="resist_frost">Resist Frost</option>
            <option value="alarm">Alarm</option>
            <option value="levitation">Levitation</option>
            <option value="arcane_flight">Arcane Flight</option>
            <option value="charm">Charm</option>
            <option value="reveal">Reveal</option>
            <option value="arcane_eye">Arcane Eye</option>
            <option value="telekinesis">Telekinesis</option>
        </select>
        </div>
        <div class="sheet-faith">
        <select name="attr_ic_effect">
            <option selected>-</option>
            <option value="fire_damage">Fire Damage</option>
            <option value="lightning_damage">Lightning Damage</option>
            <option value="shadow_damage">Shadow Damage</option>
            <option value="poison_damage">Poison Damage</option>
            <option value="water_damage">Water Damage</option>
            <option value="healing_light">Healing Light</option>
            <option value="terrify">Terrify</option>
            <option value="truth">Truth</option>
            <option value="light">Light</option>
            <option value="darkness">Darkness</option>
            <option value="resist_lightning">Resist Lightning</option>
            <option value="destroy_undead">Destroy Undead</option>
            <option value="silence">Silence</option>
            <option value="celestial_flight">Celestial Flight</option>
            <option value="become_incorporeal">Become Incorporeal</option>
            <option value="invisibility">Invisibility</option>
            <option value="ward">Ward</option>
            <option value="divine_sense">Divine Sense</option>
        </select>
        </div>
        <div class="sheet-nature">
        <select name="attr_ic_effect">
            <option selected>-</option>
            <option value="lightning_damage">Lightning Damage</option>
            <option value="ice_damage">Ice Damage</option>
            <option value="poison_damage">Poison Damage</option>
            <option value="force_damage">Force Damage</option>
            <option value="water_damage">Water Damage</option>
            <option value="balm_of_nature">Balm of Nature</option>
            <option value="pull">Pull</option>
            <option value="resist_poison">Resist Poison</option>
            <option value="feather_fall">Feather Fall</option>
            <option value="entangle">Entangle</option>
            <option value="water_breathing">Water Breathing</option>
            <option value="bark_skin">Bark Skin</option>
            <option value="reinforce_object">Reinforce Object</option>
            <option value="mending">Mending</option>
            <option value="eagle's_wings">Eagle's Wings</option>
            <option value="petrify">Petrify</option>
        </select>
        </div>
    <hr>
</div>

<script type="text/worker">

    // attributes lists
    const baseAttributes = ["Vigor","Endurance","Intelligence","Strength","Dexterity","Perception","Arcana","Faith","Nature","Charisma"];
    const armourAttributes = ["phys_armour","mag_armour"]
    const bonusAttributes = [...baseAttributes, ...armourAttributes].map(attr => attr + "_bonus");
    const allAttributes = [...baseAttributes, ...bonusAttributes];
    const baseEvents = allAttributes.map(attr => "change:" + attr).join(" ")

    // sheet tabs
    const buttonlist = ["overview","stats","attacks","perks","rune-spells","inventory","invocation"];
    buttonlist.forEach(button => {
        on(`clicked:${button}`, function() {
            setAttrs({
                sheetTab: button
            });
        });
    });

    function jsSum(...args) {
        let total = 0;
        for (let i = 0; i < args.length; i++) {
            total += parseInt(args[i]) || 0;
        }
        return total;
    }

        function getSpellDetails(effectName) {
        const spellEffects = {
            "fire_damage": [1, 0, 1, false, "Disadvantage to Contests against Wet characters.\nContested with DEX.\n1D6 => 1 FP => 0AP\n2D6 => 2 FP => 1AP\n4D6 => 4 FP => 1AP\n6D6 => 6 FP => 2AP\n9D6 => 8 FP => 2AP"],
            "ice_damage": [1, 0, 1, false "Freezes wet Characters.\nContested with Endurance.\n1D8 => 1 FP => 0AP\n2D8 => 2 FP => 1AP\n3D8 => 4 FP => 1AP\n5D8 => 6 FP => 2AP\n7D8 => 8 FP => 2AP"],
            "shadow_damage": [1, 0, 1, false "Advantage to Attack Rolls and Contests against Characters in Darkness.\nContested with Vigour.\n1D12 => 1 FP => 0AP\n2D12 => 2 FP => 1AP\n3D12 => 4 FP => 1AP\n5D12 => 6 FP => 2AP\n7D12 => 8 FP => 2AP"],
            "force_damage": [1, 0, 1, false "Deals 2 x Damage to Structures.\nContested with Strength.\n1D8 => 1 FP => 0AP\n2D8 => 2 FP => 1AP\n3D8 => 4 FP => 1AP\n5D8 => 6 FP => 2AP\n7D8 => 8 FP => 2AP"],
            "lightning_damage": [1, 0, 1, false "Advantage to Attack Rolls and Contests against Wet characters. Contested with Dexterity.\n1D10 => 1 FP => 0AP\n2D10 => 2 FP => 1AP\n3D10 => 4 FP => 1AP\n5D10 => 6 FP => 2AP\n7D10 => 8 FP => 2AP"],
            "poison_damage": [1, 0, 1, false "Contest against Target to avoid Poisoning. Contested with Vigour.\n1D6 => 1 FP => 0AP\n2D6 => 2 FP => 1AP\n3D6 => 4 FP => 1AP\n5D6 => 6 FP => 2AP\n7D6 => 8 FP => 2AP"],
            "water_damage": [1, 0, 1, false "Allies are instead Healed equal to Damage Roll. Characters Damaged or Healed become Wet. Contested with Endurance.\n1D6 => 1 FP => 0AP\n2D6 => 2 FP => 1AP\n3D6 => 4 FP => 1AP\n5D6 => 6 FP => 2AP\n7D6 => 8 FP => 2AP"],
            "dispel": [5, 1, 3, false "This magic unravels all magic it touches.\nDispel 1 in AOE."],
            "slow": [3, 1, 1, true "Slows all in range > Halves Base Movement Speed."],
            "haste": [3, 1, 4, true "Adds +10ft Base Movement Speed\nOvercharge 2: +5ft Base Movement Speed (Max 3)"],
            "freeze": [5, 1, 3, true "Freezes all Wet Characters."],
            "resist_fire": [5, 1, 4, true "Resistance to Fire Damage."],
            "resist_frost": [5, 1, 4, true "Resistance to Frost Damage + Cannot be Frozen."],
            "alarm": [4, 1, 4, true "Caster becomes aware when objects within AoE are moved or touched by another Character."],
            "levitation": [5, 2, 6, true "Allows the casters to levitate. \nLevitate â€“ 5ft\nOvercharge 2: +5ft (Max 4)"],
            "arcane_flight": [8, 2, 8, true "Fly Speed equal to Movement Speed."],
            "charm": [5, 1, 6, true "Enthrals the target with a mystical mist. "],
            "reveal": [6, 1, 5, false "Reveals and Dispels all illusions."],
            "arcane_eye": [9, 1, 10, true "30ft Magic Sight"],
            "telekinesis": [8, 2, 10, true "Allows the caster to move objects with their mind. ",
            "healing_light": [4, 1, 3, false "A golden light cleanses the wounded. Restores 1D10 Hit Points.\nOvercharge 2: +1D10 Healing (Max 6)"],
            "terrify": [5, 1, 5, true "Scary shadows frighten those afflicted."],
            "truth": [8, 1, 5, true "Characters within this effect cannot lie. If they attempt to lie, they are Silenced for 1 Minute. If they believe something to be true, then it is not considered a lie by this spell."],
            "light": [4, 1, 3, true "A glowing light illuminates the area."],
            "darkness": [5, 1, 5, true "Covers the area in thick shadow."],
            "resist_lightning": [6, 1, 4, true "Resistance to Lightning Damage."],
            "destroy_undead": [5, 1, 2, false "Destroys Level 1 Undead instantly.\nOvercharge 2: +1 Undead Level destroyed (Max 9) \n"],
            "silence": [5, 1, 5, true "All sounds is silenced."],
            "celestial_flight": [9, 2, 7, true "Fly Speed equal to Movement Speed."],
            "become_incorporeal": [9, 2, 8, false "Characters within the effect take on a ghostly visage, allowing them to move through solid objects."],
            "invisibility": [9, 2, 7, true "Bends the light to grant invisibility."],
            "ward": [8, 2, 6, true "Choose 1 Creature Type from: Undead, Devil, Demon, Celestial, Aberration. \nTarget Creature Type takes 3D10 Lightning Damage in AoE. \nOvercharge 3: +1 Creature Type (Max 4)\n"],
            "divine_sense": [6, 2, 5, true "Choose 1 Creature Type from: Undead, Devil, Demon, Celestial, Aberration. \nCaster is aware of all creatures of that type in range.\nOvercharge 3: +1 Creature Type (Max 4)"],
            "balm_of_nature": [4, 1, 3, false "Restores 1D6 Hit Points\nOverheal\nOvercharge 2: +1D6 Healing (Max 6)"],
            "pull": [4, 1, 3, false "Pulls 10ft toward Caster.\nOvercharge 1: +5ft Pull Distance (Max 6)"],
            "resist_poison": [5, 1, 4, false "Resistance to Poison Damage.\nCannot be Poisoned."],
            "feather_fall": [5, 1, 4, false "Nullifies all Fall Damage. "],
            "entangle": [5, 1, 4, false "Movement Speed reduced to 0."],
            "water_breathing": [5, 1, 1, false "Characters gain Water Breathing"],
            "bark_skin": [5, 1, 1, false "Characters gain: \n+5 Physical Armour\n-2 Magical Armour"],
            "reinforce_object": [4, 1, 4, false "Objects gains 20 + Nature Hit Points for the duration."],
            "mending": [4, 1, 4, false "Object Regains 20 + Nature Hit Points.\nOverheal."],
            "eagle's_wings": [7, 2, 7, false "Fly Speed equal to Movement Speed."],
            "petrify": [9, 2, 12, false "Petrifies characters with 0 Hit Points."],
        };

        const effectDetails = spellEffects[effectName];
        return {
            attr_required: effectDetails[0],
            ap_cost: effectDetails[1],
            fp_cost: effectDetails[2],
            concentration: effectDetails[4],
            description: effectDetails[4] || ""
        };
    }

    function getTemplateDetails(templateName) {
        const spellTemplates = {
            "touch": [1, 1, 0, false, "The caster reaches out and touches the target. Range: Touch Duration: Instant"],
            "dart": [2, 1, 1, false, "The caster shoots a small burst of magic toward the target. Range: 30ft Duration: Instant"],
            "bolt": [4, 1, 3, false, "The caster shoots a bolt of magic toward their Target. Range: 60ft Duration: Instant"],
            "orb": [5, 2, 4, false, "The caster hurls an orb of magic at a Target, which then bursts in the area around them. Range: 40ft Duration: Instant"],
            "cone": [4, 2, 4, false, "The caster shoots a cone of magic from their hands and apply the chosen Spell Effect to the Target. Range: 10ft Cone Duration: Instant"],
            "rebuttal": [5, 0, 3, false, "The caster retaliates with a blast of magic. Range: 60ft Duration: Instant"],
            "cloud": [4, 2, 4, true, "The caster conjures a lingering cloud of magic. Range: 10ft x 10ft Duration: 10 Minutes"],
            "buff": [4, 1, 3, true, "The caster empowers a character within range with a spell effect. Range: 30ft Duration: 10 Minutes Overcharge 2: +10ft Range (Max 3)"],
            "enchantment": [4, 1, 3, true, "The caster empowers an object within range with a spell effect. Range: Touch Duration: 10 Minutes"],
            "cloak": [5, 2, 5, true, "The caster surrounds themselves in a small aura of magic. Range: Self - 5ft Aura from Self Duration: 5 Minutes"],
            "aura": [8, 2, 8, true, "The caster surrounds themselves in a large aura of magic. Range: Self - 15ft Aura from Self Duration: 5 Minutes"],
            "beam": [8, 2, 8, false, "The caster shoots a beam from their hand. Range: 60ft Line Duration: Instant"],
            "wall": [9, 2, 9, false, "The caster lifts a wall up from the floor, blocking access to an area. Choose 2 Points: 5ft thick Wall appears between those two points as a straight-Line effect. Range: 60ft Line Duration: Instant"],
            "wave": [8, 2, 8, true, "The caster surrounds themselves in a large aura of magic which spreads for the duration. Each Replenish, the Wave expands 5ft, but doesn't move with the caster. Range: Self - 10ft Aura from Self Duration: 5 Minutes"],
            "explosion": [9, 2, 9, false, "The caster chooses a location, and an enormous blast of magic bursts in that spot. Range: 60ft - 15ft Radius AoE around Target Space Duration: Instant"],
            "glyph": [6, 2, 10, false, "The caster etches an invisible rune into a location as a trap ready to spring. Spell Effect is applied to that space as an Invisible Magical Effect, Triggered by a Character entering that space. * Contest is Rolled on Casting and noted down Range: Touch Duration: Instant"]
        };

        const spellTemplate = spellTemplates[templateName];
        return {
            int_required: spellTemplate[0],
            ap_cost: spellTemplate[1],
            fp_cost: spellTemplate[2],
            concentration: effectDetails[3],
            description: spellTemplate[4] || ""
        };
    }

    // Don't ask me, not my function -> https://wiki.roll20.net/RepeatingSum
    /* ===== PARAMETERS ==========
    destinations = the name of the attribute that stores the total quantity
            can be a single attribute, or an array: ['total_cost', 'total_weight']
            If more than one, the matching fields must be in the same order. 
        section = name of repeating fieldset, without the repeating_
        fields = the name of the attribute field to be summed
              destination and fields both can be a single attribute: 'weight'
              or an array of attributes: ['weight','number','equipped']
    */
    const repeatingSum = (destinations, section, fields) => {
        if (!Array.isArray(destinations)) destinations = [destinations.replace(/\s/g, '').split(',')];
        if (!Array.isArray(fields)) fields = [fields.replace(/\s/g, '').split(',')];
        getSectionIDs(`repeating_${section}`, idArray => {
            const attrArray = idArray.reduce((m, id) => [...m, ...(fields.map(field => `repeating_${section}_${id}_${field}`))], []);
            getAttrs([...attrArray], v => {
                const getValue = (section, id, field) => v[`repeating_${section}_${id}_${field}`] === 'on' ? 1 : parseFloat(v[`repeating_${section}_${id}_${field}`]) || 0;
                const commonMultipliers = (fields.length <= destinations.length) ? [] : fields.splice(destinations.length, fields.length - destinations.length);
                const output = {};
                destinations.forEach((destination, index) => {
                    output[destination] = idArray.reduce((total, id) => total + getValue(section, id, fields[index]) * commonMultipliers.reduce((subtotal, mult) => subtotal * getValue(section, id, mult), 1), 0);
                });
                setAttrs(output);
            }); 
        }); 
    };

    // calculate used spell memory
    on('change:repeating_rune-spells remove:repeating_rune-spells', function() {
        repeatingSum("spell_memory_used", "rune-spells", "rspell_ready");
    });

    // Parses out the section name, row id, and attribute/button name
    const parseTriggerName = function(string){
        let match = string.replace(/^clicked:/,'').match(/(?:(repeating_[^_]+)_([^_]+)_)?(.+)/);
        match.shift();
        return match;
    };

    // roll attack hit
    on("clicked:repeating_attacks:hit",(event) => {
        console.log("check_A")
        const [section,rowID] = parseTriggerName(event.triggerName);
        // Assemble the row string so we can use it easily later
        const row = `${section}_${rowID}`;
        // Get all the attributes we need
        // Note the async tag here. This will allow us to await 
        // startroll instead of using the callback syntax.
        getAttrs(["character_name", `${row}_attack_name`,`${row}_attack_acc_bonus`,`${row}_attack_scaling`,`${row}_attack_dice_secondary`,...allAttributes],async (attributes) => {
            // Assemble our roll string
            //const rollString = `&{template:demo} {{roll=[[${attributes[`${row}_option_1`]} + ${attributes[`${row}_option_2`]} + ${attributes[`${row}_bonus`]}]]}} {{damage=[[${attributes[`${row}_damage`]}[base damage]]]}}`;
            console.log(attributes)
            //const rollString = `/roll 1d20 ${window["attributes." + row + "_attack_name"]}`; // TODO research roll templates
            console.log(window[row + "_attack_name"])
            console.log(attributes["character_name"])
            const scaling = attributes[`${row}_attack_scaling`]
            const acc = jsSum(attributes[`${scaling}`], attributes[`${scaling}_bonus`], attributes[`${row}_attack_acc_bonus`])
            console.log(scaling)
            console.log(acc)
            const rollString = `&{template:demo} {{name=${attributes[`${row}_attack_name`]}}} {{roll=[[1d20]]}} {{mod=[[${acc}]]}}`
            console.log(rollString)
            // Send the roll to the parser
            const results = await startRoll(rollString);
            // Tell roll20 that the roll is ready to be displayed in chat
            finishRoll(results.rollId);
        })
    })

    // reset values on rest
    on("clicked:rest", function() {
        getAttrs(["hp_max", "vitality_max", "fp_max", "sp_max"], function(values) {
            setAttrs({
                hp: values.hp_max,
                vitality: values.vitality_max, // TODO check current rules for vitality reset
                fp: values.fp_max,
                sp: values.sp_max,
         });
        });
    });

    // general attribute changes
    on("sheet:opened change:xp change:hp_bonus change:vitality_bonus change:fp_bonus change:sp_bonus change:race " + baseEvents, function() {
        getAttrs(["xp","race","hp_bonus","vitality_bonus","fp_bonus","sp_bonus","initiative_bonus","evasion_bonus","speed_bonus","equip_load_bonus",...allAttributes], function(values) {

            function getRaceSpeed(race) {
                const raceValues = {
                    "Dwarf": 15,
                    "Smallfolk": 15,
                    "Turtlefolk": 15,
                    "Demi-Giant": 25,
                };
                return raceValues[race] || 20;
            }

            function getAttributeCost(attribute) {
                let attributeLevel = parseInt(attribute);
                if (attributeLevel == 1) {return 0;}
                return attributeLevel/2 * (1 + attributeLevel) - 1;
            }

            function getNextXP(items) {
                return baseAttributes.reduce((nextXP, attribute) => {
                    nextXP[`${attribute}_next`] = parseInt(items[attribute]) + 1;
                    return nextXP;
                }, {});
            }

            function getLevel(xp)
            {
                const thresholds = [100, 105, 110, 115, 120, 125, 132, 139, 146, 153, 160, 170, 180, 190, 200, 210, 220, 230, 240, 250];
                let level = 0;
                while (xp >= thresholds[level]) {
                    level++;
                    if (level >= thresholds.length) {
                        level = Math.floor((xp - 250) / 10) * 2 + 21;
                        break;
                    }
                }
                return level;
            }

            const calcHP = 10 + jsSum(values.Vigor, values.Vigor_bonus) * 8 + jsSum(values.Endurance, values.Endurance_bonus, values.Strength);
            const calcVitality = jsSum("1", Math.floor(jsSum(values.Vigor, values.Vigor_bonus) / 2));
            const calcFP = jsSum(values.Intelligence, values.Intelligence_bonus, values.Charisma, values.Charisma_bonus) * 3 + jsSum(values.Perception, values.Perception_bonus, values.Arcana, values.Arcana_bonus, values.Faith, values.Faith_bonus, values.Nature, values.Nature_bonus);
            const calcSP = jsSum(values.Endurance, values.Endurance_bonus);
            const calcInitiative = jsSum(values.Dexterity, values.Dexterity_bonus, values.Perception, values.Perception_bonus);
            const calcEvasion = jsSum(10, values.Dexterity, values.Dexterity_bonus);
            const calcSpeed = jsSum(getRaceSpeed(values.race), Math.floor(jsSum(values.Endurance, values.Endurance_bonus) / 2) * 5);
            const calcEquipLoad = jsSum(values.Strength, values.Strength_bonus)
            const calcXpUsed = baseAttributes.reduce((accumulator, attribute) => accumulator + getAttributeCost(values[attribute]), 0);
            const nextXP = getNextXP(values);

            console.log(values)
            console.log(calcXpUsed)

            setAttrs(Object.assign({
                hp_base: calcHP,
                hp_max: jsSum(calcHP, values.hp_bonus),
                vitality_base: calcVitality,
                vitality_max: jsSum(calcVitality, values.vitality_bonus),
                fp_base: calcFP,
                fp_max: jsSum(calcFP, values.fp_bonus),
                sp_base: calcSP,
                sp_max: jsSum(calcSP, values.sp_bonus),
                initiative_base: calcInitiative,
                initiative_total: jsSum(calcInitiative, values.initiative_bonus),
                evasion_base: calcEvasion,
                evasion_total: jsSum(calcEvasion, values.evasion_bonus),
                speed_base: calcSpeed,
                speed_total: jsSum(calcSpeed, values.speed_bonus),
                level: getLevel(values.xp),
                xp_used: calcXpUsed,
                equip_load_base: calcEquipLoad,
                equip_load_max: jsSum(calcEquipLoad, values.equip_load_bonus),
                spell_memory: jsSum(values.Intelligence, values.Intelligence_bonus) * 3,
                phys_armour_total: jsSum(values.phys_armour, values.phys_armour_bonus),
                mag_armour_total: jsSum(values.mag_armour, values.mag_armour_bonus)
            }, nextXP));
        });
    });


</script>

<rolltemplate class="sheet-rolltemplate-demo">
  name: {{name}} roll: {{roll}} mod: {{mod}}
</rolltemplate>