<input type="hidden" class="sheet-tabstoggle" name="attr_sheetTab" value="character"/>
<div>
    <button type="action" name="act_overview">Overview</button>
    <button type="action" name="act_stats">Stats</button>
    <button type="action" name="act_attacks">Attacks</button>
</div>

<div class="sheet-overview">
    <text> Name:</text>
    <input type="text" name="attr_character_name" readonly/><br>
    Race: <input type="text" name="attr_race" value="" readonly/><br>

    <strong> Level: </strong>
    <input type="number" name="attr_level" value="1" readonly/><br>
    <strong> Initiative: </strong>
    <input type="number" name="attr_initiative_total" value="1" readonly/><br>
    <strong> Evasion: </strong>
    <input type="number" name="attr_evasion_total" value="1" readonly/><br>
    <strong> Speed: </strong>
    <input type="number" name="attr_speed_total" value="1" readonly/><br>
    <strong> Equip Load: </strong>
    <input type="number" value="0" name="attr_equip_load"/>
    <text> /</text>
    <input type="number" value="1" name="attr_equip_load_max" readonly/><br>

    <strong> Health: </strong>
    <input type="number" value="0" name="attr_hp"/>
    <text> /</text>
    <input type="number" value="10" name="attr_hp_max" readonly/>

    <strong> Vitality: </strong>
    <input type="number" value="0" name="attr_vitality"/>
    <text> /</text>
    <input type="number" value="10" name="attr_vitality_max" readonly/>

    <strong> Focus: </strong>
    <input type="number" value="0" name="attr_fp"/>
    <text> /</text>
    <input type="number" value="10" name="attr_fp_max" readonly/>

    <strong> Stamina: </strong>
    <input type="number" value="0" name="attr_sp"/>
    <text> /</text>
    <input type="number" value="10" name="attr_sp_max" readonly/>
    <br>
    <button type="action" name="act_rest">Rest</button>


    <hr>
    <h2>Character Stats</h2>

    <br>
    <h3> Vigor </h3>
    <input type="number" name="attr_Vigor" value="1" min="1" readonly/>
    <button type='roll' value="/roll 1d20 + @{Vigor} + @{Vigor_bonus} Vigor" name="roll_Vigor"></button>
    <br>
    <h3> Endurance </h3>
    <input type="number" name="attr_Endurance" value="1" min="1" readonly/>
    <button type='roll' value="/roll 1d20 + @{Endurance} + @{Endurance_bonus} Endurance" name="roll_Endurance"></button>
    <br>
    <h3> Intelligence </h3>
    <input type="number" name="attr_Intelligence" value="1" min="1" readonly/>
    <button type='roll' value="/roll 1d20 + @{Intelligence} + @{Intelligence_bonus} Intelligence" name="roll_Intelligence"></button>
    <br>
    <h3> Strength </h3>
    <input type="number" name="attr_Strength" value="1" min="1" readonly/>
    <button type='roll' value="/roll 1d20 + @{Strength} + @{Strength_bonus} Strength" name="roll_Strength"></button>
    <br>
    <h3> Dexterity </h3>
    <input type="number" name="attr_Dexterity" value="1" min="1" readonly/>
    <button type='roll' value="/roll 1d20 + @{Dexterity} + @{Dexterity_bonus} Dexterity" name="roll_Dexterity"></button>
    <br>
    <h3> Perception </h3>
    <input type="number" name="attr_Perception" value="1" min="1"/>
    <button type='roll' value="/roll 1d20 + @{Perception} + @{Perception_bonus} Perception" name="roll_Perception"></button>
    <br>
    <h3> Arcana </h3>
    <input type="number" name="attr_Arcana" value="1" min="1"/>
    <button type='roll' value="/roll 1d20 + @{Arcana} + @{Arcana_bonus} Arcana" name="roll_Arcana"></button>
    <br>
    <h3> Faith </h3>
    <input type="number" name="attr_Faith" value="1" min="1"/>
    <button type='roll' value="/roll 1d20 + @{Faith} + @{Faith_bonus} Faith" name="roll_Faith"></button>
    <br>
    <h3> Nature </h3>
    <input type="number" name="attr_Nature" value="1" min="1"/>
    <button type='roll' value="/roll 1d20 + @{Nature} + @{Nature_bonus} Nature" name="roll_Nature"></button>
    <br>
    <h3> Charisma </h3>
    <input type="number" name="attr_Charisma" value="1" min="1"/>
    <button type='roll' value="/roll 1d20 + @{Charisma} + @{Charisma_bonus} Charisma" name="roll_Charisma"></button>

    <br><strong>Attacks:</strong><br>
    <hr>
    <h2>Attacks</h2>
    <fieldset class="repeating_attacks">
        <Strong>Name:</Strong>
        <input type="text" name="attr_attack_name" readonly/>
        <button type="action" name="act_hit">Hit</button>
    </fieldset>
    <hr>

    <br><strong>Notes:</strong><br>
    <textarea name="attr_backstory" rows="10" cols="10"></textarea>
</div>

<div class="sheet-stats">
    <text> Name:</text>
    <input type="text" name="attr_character_name"/><br>
    Race:
    <select name="attr_race">
        <option selected>Race</option>
        <option value="Human">Human</option>
        <option value="Half-Orc">Half-Orc</option>
        <option value="Orc">Orc</option>
        <option value="Seasonal Elf">Seasonal Elf</option>
        <option value="Sun Elf">Sun Elf</option>
        <option value="Moon Elf">Moon Elf</option>
        <option value="Half-Elf">Half-Elf</option>
        <option value="Dwarf">Dwarf</option>
        <option value="Smallfolk">Smallfolk</option>
        <option value="Felis">Felis</option>
        <option value="Beast Chibiki">Beast Chibiki</option>
        <option value="Merfolk">Merfolk</option>
        <option value="Turtlefolk">Turtlefolk</option>
        <option value="Demi-Giant">Demi-Giant</option>
        <option value="Dragonkin">Dragonkin</option>
        <option value="Djuri">Djuri</option>
        <option value="Construct">Construct</option>
        <option value="Changeling">Changeling</option>
        <option value="Devilkin">Devilkin</option>
    </select>
    <br>

    <strong> XP: </strong>
    <input type="number" name="attr_xp" value="1"/>
    <strong> Level: </strong>
    <input type="number" name="attr_level" value="1" readonly/>
    <br>

    <strong> Health: </strong>
    <input type="number" value="10" name="attr_hp_base" readonly/>
    <text>Bonus</text>
    <input type="number" name="attr_hp_bonus" value="0"/>
    <br>

    <strong> Vitality: </strong>
    <input type="number" value="1" name="attr_vitality_base" readonly/>
    <text>Bonus</text>
    <input type="number" name="attr_vitality_bonus" value="0"/>
    <br>

    <strong> Focus: </strong>
    <input type="number" value="10" name="attr_fp_base" readonly/>
    <text>Bonus</text>
    <input type="number" name="attr_focus_bonus" value="0"/>
    <br>

    <strong> Stamina: </strong>
    <input type="number" value="1" name="attr_sp_base" readonly/>
    <text>Bonus</text>
    <input type="number" name="attr_sp_bonus" value="0"/>
    <br>

    <strong> Initiative: </strong>
    <input type="number" value="1" name="attr_initiative_base" readonly/>
    <text>Bonus</text>
    <input type="number" name="attr_initiative_bonus" value="0"/>
    <br>

    <strong> Evasion: </strong>
    <input type="number" value="1" name="attr_evasion_base" readonly/>
    <text>Bonus</text>
    <input type="number" name="attr_evasion_bonus" value="0"/>
    <br>

    <strong> Speed: </strong>
    <input type="number" value="20" name="attr_speed_base" readonly/>
    <text>Bonus</text>
    <input type="number" name="attr_speed_bonus" value="0"/>
    <br>

    <strong> Equip Load: </strong>
    <input type="number" value="1" name="attr_equip_load_base" readonly/>
    <text>Bonus</text>
    <input type="number" name="attr_equip_load_bonus" value="0"/>
    <br>

    <hr>
    <h2>Character Stats</h2>

    <br>
    <h3> Vigor </h3>
    <text>Score</text>
    <input type="number" name="attr_Vigor" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_Vigor_bonus" value="0"/>
    <br>
    <h3> Endurance </h3>
    <text>Score</text>
    <input type="number" name="attr_Endurance" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_Endurance_bonus" value="0"/>
    <br>
    <h3> Intelligence </h3>
    <text>Score</text>
    <input type="number" name="attr_Intelligence" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_Intelligence_bonus" value="0"/>
    <br>
    <h3> Strength </h3>
    <text>Score</text>
    <input type="number" name="attr_Strength" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_Strength_bonus" value="0"/>
    <br>
    <h3> Dexterity </h3>
    <text>Score</text>
    <input type="number" name="attr_Dexterity" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_Dexterity_bonus" value="0"/>
    <br>
    <h3> Perception </h3>
    <text>Score</text>
    <input type="number" name="attr_Perception" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_Perception_bonus" value="0"/>
    <br>
    <h3> Arcana </h3>
    <text>Score</text>
    <input type="number" name="attr_Arcana" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_Arcana_bonus" value="0"/>
    <br>
    <h3> Faith </h3>
    <text>Score</text>
    <input type="number" name="attr_Faith" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_Faith_bonus" value="0"/>
    <br>
    <h3> Nature </h3>
    <text>Score</text>
    <input type="number" name="attr_Nature" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_Nature_bonus" value="0"/>
    <br>
    <h3> Charisma </h3>
    <text>Score</text>
    <input type="number" name="attr_Charisma" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_Charisma_bonus" value="0"/>
</div>

<div class="sheet-attacks">
    <hr>
    <h2>Attacks</h2>
    <fieldset class="repeating_attacks">
        <Strong>Name:</Strong>
        <input type="text" name="attr_attack_name"/>
        Acc Bonus:
        <input type="number" name="attr_attack_acc_bonus"/>
        Dmg Bonus:
        <input type="number" name="attr_attack_dmg_bonus"/>
        Is Weapon
        <input type="checkbox" name="attr_attack_type"/>
        Scaling:
        <select name="attr_attack_scaling">
            <option selected>-</option>
            <option value="Vigor">Vigor</option>
            <option value="Endurance">Endurance</option>
            <option value="Intelligence">Intelligence</option>
            <option value="Strength">Strength</option>
            <option value="Dexterity">Dexterity</option>
            <option value="Perception">Perception</option>
            <option value="Arcana">Arcana</option>
            <option value="Faith">Faith</option>
            <option value="Nature">Nature</option>
            <option value="Charisma">Charisma</option>
        </select>
        One-Handed Dice:
        <input type="text" name="attr_attack_dice_one"/>
        Type:
        <select name="attr_attack_type_one">
            <option selected>-</option>
            <option value="Slashing">Slashing</option>
            <option value="Piercing">Piercing</option>
            <option value="Bludgeoning">Bludgeoning</option>
            <option value="Fire">Fire</option>
            <option value="Frost">Frost</option>
            <option value="Lightning">Lightning</option>
            <option value="Shadow">Shadow</option>
            <option value="Water">Water</option>
            <option value="Poison">Poison</option>
        </select>
        Two-Handed Dice:
        <input type="text" name="attr_attack_dice_two"/>
        Type:
        <select name="attr_attack_type_two">
            <option selected>-</option>
            <option value="Slashing">Slashing</option>
            <option value="Piercing">Piercing</option>
            <option value="Bludgeoning">Bludgeoning</option>
            <option value="Fire">Fire</option>
            <option value="Frost">Frost</option>
            <option value="Lightning">Lightning</option>
            <option value="Shadow">Shadow</option>
            <option value="Water">Water</option>
            <option value="Poison">Poison</option>
        </select>
        Secondary Dice:
        <input type="text" name="attr_attack_dice_secondary"/>
        Type:
        <select name="attr_attack_type_secondary">
            <option selected>-</option>
            <option value="Slashing">Slashing</option>
            <option value="Piercing">Piercing</option>
            <option value="Bludgeoning">Bludgeoning</option>
            <option value="Fire">Fire</option>
            <option value="Frost">Frost</option>
            <option value="Lightning">Lightning</option>
            <option value="Shadow">Shadow</option>
            <option value="Water">Water</option>
            <option value="Poison">Poison</option>
        </select>
    </fieldset>
    <hr>
</div>

<script type="text/worker">

    function jsSum(...args) {
        let total = 0;
        for (let i = 0; i < args.length; i++) {
            total += parseInt(args[i]) || 0;
        }
        return total;
    }
    const baseAttributes = ["Vigor","Endurance","Intelligence","Strength","Dexterity","Perception","Arcana","Faith","Nature","Charisma"];
    const bonusAttributes = baseAttributes.map(attr => attr + "_bonus");
    const allAttributes = [...baseAttributes, ...bonusAttributes];
    const baseEvents = allAttributes.map(attr => "change:" + attr).join(" ")
    // Parses out the section name, row id, and attribute/button name
    const parseTriggerName = function(string){
        let match = string.replace(/^clicked:/,'').match(/(?:(repeating_[^_]+)_([^_]+)_)?(.+)/);
        match.shift();
        return match;
    };

    on("clicked:repeating_attacks:hit",(event) => {
        console.log("check_A")
        const [section,rowID] = parseTriggerName(event.triggerName);
        // Assemble the row string so we can use it easily later
        const row = `${section}_${rowID}`;
        // Get all the attributes we need
        // Note the async tag here. This will allow us to await 
        // startroll instead of using the callback syntax.
        getAttrs([`${row}_attack_name`,`${row}_attack_acc_bonus`,`${row}_attack_scaling`,`${row}_attack_dice_secondary`,...allAttributes],async (attributes) => {
            // Assemble our roll string
            //const rollString = `&{template:demo} {{roll=[[${attributes[`${row}_option_1`]} + ${attributes[`${row}_option_2`]} + ${attributes[`${row}_bonus`]}]]}} {{damage=[[${attributes[`${row}_damage`]}[base damage]]]}}`;
            console.log(attributes)
            //const rollString = `/roll 1d20 ${window["attributes." + row + "_attack_name"]}`; // TODO research roll templates
            console.log(window[row + "_attack_name"])
            const scaling = attributes[`${row}_attack_scaling`]
            const acc = jsSum(attributes[`${scaling}`], attributes[`${scaling}_bonus`], attributes[`${row}_attack_acc_bonus`])
            console.log(scaling)
            console.log(acc)
            const rollString = `&{template:demo} {{name=${attributes[`${row}_attack_name`]}}} {{roll=[[1d20]]}} {{mod=[[${acc}]]}}`
            console.log(rollString)
            // Send the roll to the parser
            const results = await startRoll(rollString);
            // Tell roll20 that the roll is ready to be displayed in chat
            finishRoll(results.rollId);
        })
    })


    // sheet tabs
    const buttonlist = ["overview","stats","attacks"];
    buttonlist.forEach(button => {
        on(`clicked:${button}`, function() {
            setAttrs({
                sheetTab: button
            });
        });
    });

    // reset values on rest
    on("clicked:rest", function() {
        getAttrs(["hp_max", "vitality_max", "fp_max", "sp_max"], function(values) {
            setAttrs({
                hp: values.hp_max,
                vitality: values.vitality_max, // TODO check current rules for vitality reset
                fp: values.fp_max,
                sp: values.sp_max,
         });
        });
    });

    // general attribute changes
    on("sheet:opened change:xp change:hp_bonus change:vitality_bonus change:fp_bonus change:sp_bonus change:race " + baseEvents, function() {
        getAttrs(["xp","race","hp_bonus","vitality_bonus","fp_bonus","sp_bonus","initiative_bonus","evasion_bonus","speed_bonus","equip_load_bonus",...allAttributes], function(values) {

            function getRaceSpeed(race) {
                const raceValues = {
                    "Dwarf": 15,
                    "Smallfolk": 15,
                    "Turtlefolk": 15,
                    "Demi-Giant": 25,
                };
                return raceValues[race] || 20;
            }

            function getLevel(xp)
            {
                const thresholds = [100, 105, 110, 115, 120, 125, 132, 139, 146, 153, 160, 170, 180, 190, 200, 210, 220, 230, 240, 250];
                let level = 0;
                while (xp >= thresholds[level]) {
                    level++;
                    if (level >= thresholds.length) {
                        level = Math.floor((xp - 250) / 10) * 2 + 21;
                        break;
                    }
                }
                return level;
            }

            let calcHP = 10 + jsSum(values.Vigor, values.Vigor_bonus) * 8 + jsSum(values.Endurance, values.Endurance_bonus, values.Strength);
            let calcVitality = jsSum("1", Math.floor(jsSum(values.Vigor, values.Vigor_bonus) / 2));
            let calcFP = jsSum(values.Intelligence, values.Intelligence_bonus, values.Charisma, values.Charisma_bonus) * 3 + jsSum(values.Perception, values.Perception_bonus, values.Arcana, values.Arcana_bonus, values.Faith, values.Faith_bonus, values.Nature, values.Nature_bonus);
            let calcSP = jsSum(values.Endurance, values.Endurance_bonus);
            let calcInitiative = jsSum(values.Dexterity, values.Dexterity_bonus, values.Perception, values.Perception_bonus);
            let calcEvasion = jsSum(10, values.Dexterity, values.Dexterity_bonus);
            let calcSpeed = jsSum(getRaceSpeed(values.race), Math.floor(jsSum(values.Endurance, values.Endurance_bonus) / 2) * 5);
            let calcEquipLoad = jsSum(values.Strength, values.Strength_bonus)

            console.log(values)

            setAttrs({
                hp_base: calcHP,
                hp_max: jsSum(calcHP, values.hp_bonus),
                vitality_base: calcVitality,
                vitality_max: jsSum(calcVitality, values.vitality_bonus),
                fp_base: calcFP,
                fp_max: jsSum(calcFP, values.fp_bonus),
                sp_base: calcSP,
                sp_max: jsSum(calcSP, values.sp_bonus),
                initiative_base: calcInitiative,
                initiative_total: jsSum(calcInitiative, values.initiative_bonus),
                evasion_base: calcEvasion,
                evasion_total: jsSum(calcEvasion, values.evasion_bonus),
                speed_base: calcSpeed,
                speed_total: jsSum(calcSpeed, values.speed_bonus),
                level: getLevel(values.xp),
                equip_load_base: calcEquipLoad,
                equip_load_max: jsSum(calcEquipLoad, values.equip_load_bonus),
            });
        });
    });


</script>

<rolltemplate class="sheet-rolltemplate-demo">
  name: {{name}} roll: {{roll}} mod: {{mod}}
</rolltemplate>