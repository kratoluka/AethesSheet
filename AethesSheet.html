<input type="hidden" class="sheet-tabstoggle" name="attr_sheetTab" value="character"/>
<div>
    <button type="action" name="act_overview">Overview</button>
    <button type="action" name="act_stats">Stats</button>
</div>

<div class="sheet-overview">
    <text> Name:</text>
    <input type="text" name="attr_character_name" readonly/><br>
    Race: <input type="text" name="attr_race" value="" readonly/><br>

    <strong> Level: </strong>
    <input type="number" name="attr_level" value="1" readonly/><br>
    <strong> Initiative: </strong>
    <input type="number" name="attr_initiative" value="1" readonly/><br>
    <strong> Evasion: </strong>
    <input type="number" name="attr_evasion" value="1" readonly/><br>
    <strong> Speed: </strong>
    <input type="number" name="attr_speed" value="1" readonly/><br>
    <strong> Equip Load: </strong>
    <input type="number" value="0" name="attr_equip_load"/>
    <text> /</text>
    <input type="number" value="10" name="attr_equip_load_max" readonly/><br>

    <strong> Health: </strong>
    <input type="number" value="0" name="attr_hp"/>
    <text> /</text>
    <input type="number" value="10" name="attr_hp_max" readonly/>

    <strong> Vitality: </strong>
    <input type="number" value="0" name="attr_vitality"/>
    <text> /</text>
    <input type="number" value="10" name="attr_vitality_max" readonly/>

    <strong> Focus: </strong>
    <input type="number" value="0" name="attr_fp"/>
    <text> /</text>
    <input type="number" value="10" name="attr_fp_max" readonly/>

    <strong> Stamina: </strong>
    <input type="number" value="0" name="attr_sp"/>
    <text> /</text>
    <input type="number" value="10" name="attr_sp_max" readonly/>
    <br>
    <button type="action" name="act_rest">Rest</button>


    <hr>
    <h2>Character Stats</h2>

    <br>
    <h3> Vigor </h3>
    <input type="number" name="attr_vig" value="1" min="1" readonly/>
    <button type='roll' value="/roll 1d20 + @{vig} + @{vig_bonus} Vigor" name="roll_vig"></button>
    <br>
    <h3> Endurance </h3>
    <input type="number" name="attr_end" value="1" min="1" readonly/>
    <button type='roll' value="/roll 1d20 + @{end} + @{end_bonus} Endurance" name="roll_end"></button>
    <br>
    <h3> Intelligence </h3>
    <input type="number" name="attr_int" value="1" min="1" readonly/>
    <button type='roll' value="/roll 1d20 + @{int} + @{int_bonus} Intelligence" name="roll_int"></button>
    <br>
    <h3> Strength </h3>
    <input type="number" name="attr_str" value="1" min="1" readonly/>
    <button type='roll' value="/roll 1d20 + @{str} + @{str_bonus} Strength" name="roll_str"></button>
    <br>
    <h3> Dexterity </h3>
    <input type="number" name="attr_dex" value="1" min="1" readonly/>
    <button type='roll' value="/roll 1d20 + @{dex} + @{dex_bonus} Dexterity" name="roll_dex"></button>
    <br>
    <h3> Perception </h3>
    <input type="number" name="attr_per" value="1" min="1"/>
    <button type='roll' value="/roll 1d20 + @{per} + @{per_bonus} Perception" name="roll_per"></button>
    <br>
    <h3> Arcana </h3>
    <input type="number" name="attr_arc" value="1" min="1"/>
    <button type='roll' value="/roll 1d20 + @{arc} + @{arc_bonus} Arcana" name="roll_arc"></button>
    <br>
    <h3> Faith </h3>
    <input type="number" name="attr_fai" value="1" min="1"/>
    <button type='roll' value="/roll 1d20 + @{fai} + @{fai_bonus} Faith" name="roll_fai"></button>
    <br>
    <h3> Nature </h3>
    <input type="number" name="attr_nat" value="1" min="1"/>
    <button type='roll' value="/roll 1d20 + @{nat} + @{nat_bonus} Nature" name="roll_nat"></button>
    <br>
    <h3> Charisma </h3>
    <input type="number" name="attr_chr" value="1" min="1"/>
    <button type='roll' value="/roll 1d20 + @{cha} + @{cha_bonus} Charisma" name="roll_cha"></button>

    <br><strong>Notes:</strong><br>
    <textarea name="attr_backstory" rows="10" cols="10"></textarea>
</div>

<div class="sheet-stats">
    <text> Name:</text>
    <input type="text" name="attr_character_name"/><br>
    Race:
    <select name="attr_race">
        <option selected>Race</option>
        <option value="Human">Human</option>
        <option value="Half-Orc">Half-Orc</option>
        <option value="Orc">Orc</option>
        <option value="Seasonal Elf">Seasonal Elf</option>
        <option value="Sun Elf">Sun Elf</option>
        <option value="Moon Elf">Moon Elf</option>
        <option value="Half-Elf">Half-Elf</option>
        <option value="Dwarf">Dwarf</option>
        <option value="Smallfolk">Smallfolk</option>
        <option value="Felis">Felis</option>
        <option value="Beast Chibiki">Beast Chibiki</option>
        <option value="Merfolk">Merfolk</option>
        <option value="Turtlefolk">Turtlefolk</option>
        <option value="Demi-Giant">Demi-Giant</option>
        <option value="Dragonkin">Dragonkin</option>
        <option value="Djuri">Djuri</option>
        <option value="Construct">Construct</option>
        <option value="Changeling">Changeling</option>
        <option value="Devilkin">Devilkin</option>
    </select>
    <br>

    <strong> XP: </strong>
    <input type="number" name="attr_xp" value="1"/>
    <strong> Level: </strong>
    <input type="number" name="attr_level" value="1" readonly/>
    <br>

    <strong> Health: </strong>
    <input type="number" value="10" name="attr_hp_max" readonly/>
    <text>Bonus</text>
    <input type="text" name="attr_hp_bonus" value="0"/>
    <br>

    <strong> Vitality: </strong>
    <input type="number" value="1" name="attr_vitality_max" readonly/>
    <text>Bonus</text>
    <input type="text" name="attr_vitality_bonus" value="0"/>
    <br>

    <strong> Focus: </strong>
    <input type="number" value="10" name="attr_fp_max" readonly/>
    <text>Bonus</text>
    <input type="text" name="attr_focus_bonus" value="0"/>
    <br>

    <strong> Stamina: </strong>
    <input type="number" value="1" name="attr_sp_max" readonly/>
    <text>Bonus</text>
    <input type="text" name="attr_sp_bonus" value="0"/>
    <br>

    <strong> Initiative: </strong>
    <input type="number" value="1" name="attr_initiative" readonly/>
    <text>Bonus</text>
    <input type="text" name="attr_initiative_bonus" value="0"/>
    <br>

    <strong> Evasion: </strong>
    <input type="number" value="1" name="attr_evasion" readonly/>
    <text>Bonus</text>
    <input type="text" name="attr_evasion_bonus" value="0"/>
    <br>

    <strong> Speed: </strong>
    <input type="number" value="20" name="attr_speed" readonly/>
    <text>Bonus</text>
    <input type="text" name="attr_speed_bonus" value="0"/>
    <br>

    <strong> Equip Load: </strong>
    <input type="number" value="1" name="attr_equip_load_max" readonly/>
    <text>Bonus</text>
    <input type="text" name="attr_equip_load_bonus" value="0"/>
    <br>

    <hr>
    <h2>Character Stats</h2>

    <br>
    <h3> Vigor </h3>
    <text>Score</text>
    <input type="number" name="attr_vig" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_vig_bonus" value="0"/>
    <br>
    <h3> Endurance </h3>
    <text>Score</text>
    <input type="number" name="attr_end" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_end_bonus" value="0"/>
    <br>
    <h3> Intelligence </h3>
    <text>Score</text>
    <input type="number" name="attr_int" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_int_bonus" value="0"/>
    <br>
    <h3> Strength </h3>
    <text>Score</text>
    <input type="number" name="attr_str" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_str_bonus" value="0"/>
    <br>
    <h3> Dexterity </h3>
    <text>Score</text>
    <input type="number" name="attr_dex" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_dex_bonus" value="0"/>
    <br>
    <h3> Perception </h3>
    <text>Score</text>
    <input type="number" name="attr_per" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_per_bonus" value="0"/>
    <br>
    <h3> Arcana </h3>
    <text>Score</text>
    <input type="number" name="attr_arc" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_arc_bonus" value="0"/>
    <br>
    <h3> Faith </h3>
    <text>Score</text>
    <input type="number" name="attr_fai" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_fai_bonus" value="0"/>
    <br>
    <h3> Nature </h3>
    <text>Score</text>
    <input type="number" name="attr_nat" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_nat_bonus" value="0"/>
    <br>
    <h3> Charisma </h3>
    <text>Score</text>
    <input type="number" name="attr_cha" value="1" min="1"/>
    <text>Bonus</text>
    <input type="text" name="attr_cha_bonus" value="0"/>

    <hr>
    <h2>Skill Bonuses</h2>
    <fieldset class="repeating_skills">
        <Strong>Name:</Strong>
        <input type="text" name="attr_skillname"/>
        Rank:
        <input type="number" name="attr_skillRank"/>
        Rerolls:
        <input type="number" name="attr_rerolls"/>
        /
        <input type="number" name="attr_rerolls_max"/>
        Is Master?
        <input type="checkbox" name="attr_skillMaster"/>
    </fieldset>
    <hr>
</div>

<script type="text/worker">
    // sheet tabs
    const buttonlist = ["overview","stats"];
    buttonlist.forEach(button => {
        on(`clicked:${button}`, function() {
            setAttrs({
                sheetTab: button
            });
        });
    });
    on("clicked:rest", function() {
        getAttrs(["hp_max", "vitality_max", "fp_max", "sp_max"], function(values) {
            setAttrs({
                hp: values.hp_max,
                vitality: values.vitality_max, // TODO check current rules for vitality reset
                fp: values.fp_max,
                sp: values.sp_max,
            });
        });
    });
    on("sheet:opened change:xp change:hp_bonus change:fp_bonus change:sp_bonus change:race change:vig change:vig_bonus change:end change:end_bonus change:int change:int_bonus change:str change:str_bonus change:dex change:dex_bonus change:per change:per_bonus change:arc change:arc_bonus change:fai change:fai_bonus change:nat change:nat_bonus change:cha change:cha_bonus", function() {
        getAttrs(["xp","race","vig","vig_bonus","end","end_bonus","str","str_bonus","int","int_bonus","dex","dex_bonus","per","per_bonus","arc","arc_bonus","fai","fai_bonus","nat","nat_bonus","cha","cha_bonus"], function(values) {

            function getRaceSpeed(race) {
                const raceValues = {
                    "Dwarf": 15,
                    "Smallfolk": 15,
                    "Turtlefolk": 15,
                    "Demi-Giant": 25,
                };
                return raceValues[race] || 20;
            }

            function getLevel(xp)
            {
                const thresholds = [100, 105, 110, 115, 120, 125, 132, 139, 146, 153, 160, 170, 180, 190, 200, 210, 220, 230, 240, 250];
                let level = 0;
                while (xp >= thresholds[level]) {
                    level++;
                    if (level >= thresholds.length) {
                        level = Math.floor((xp - 250) / 10) * 2 + 21;
                        break;
                    }
                }
                return level;
            }

            function jsSum(...args) {
                let total = 0;
                for (let i = 0; i < args.length; i++) {
                    total += parseInt(args[i]) || 0;
                }
                return total;
            }

            let calcHP = 10 + jsSum(values.vig, values.vig_bonus) * 8 + jsSum(values.end, values.end_bonus, values.str, values.hp_bonus);
            let calcVitality = 1 + Math.floor(parseInt(values.vig) / 2);
            let calcFP = jsSum(values.int, values.int_bonus, values.cha, values.cha_bonus) * 3 + jsSum(values.per, values.per_bonus, values.arc, values.arc_bonus, values.fai, values.fai_bonus, values.nat, values.nat_bonus, values.fp_bonus);
            let calcSP = jsSum(values.end, values.end_bonus, values.sp_bonus);
            let calcInitiative = jsSum(values.dex, values.per);
            let calcEvasion = jsSum(10, values.dex);
            let calcSpeed = getRaceSpeed(values.race) + Math.floor(parseInt(values.end) / 2) * 5;

            console.log(values)

            setAttrs({
                hp_max: calcHP,
                vitality_max: calcVitality,
                fp_max: calcFP,
                sp_max: calcSP,
                initiative: calcInitiative,
                evasion: calcEvasion,
                speed: calcSpeed,
                level: getLevel(values.xp),
            });
        });
    });




</script>